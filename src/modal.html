<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="robots" content="noindex,nofollow">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="modal.css" rel="stylesheet">
		<script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
		<title>モーダルウィンドウのデモ</title>
	</head>

	<body style="margin: 0; overflow: hidden;">
		<p><a id="modal-open" class="button-link">クリックするとモーダルウィンドウを開きます。</a></p>

		<HR style="margin: 3em 0 ;">
		
		<!-- ここからモーダルウィンドウ -->
		<div id="modal-content">
			<p>fetchAPIをテストするページver.5</p>
    		<label for="plase">行きたい場所を選択</label>
    		<select id="plase">
    		    <option value="1">粉とクリーム</option>
    		    <option value="2">つくば駅</option>
    		    <option value="3">春日宿舎</option>
    		    <option value="4">一の矢宿舎</option>
    		    <option value="5">大学会館</option>
    		    <option value="6">中央図書館</option>
    		    <option value="7">大学本部</option>
    		    <option value="8">カスミ筑波大学店</option>
    		    <option value="9">筑波大学附属病院</option>
    		    <option value="10">ヒューマン･ハイ･パフォーマンス先端研究センター</option>
    		</select>
    		<br>
    		<p>返答: <span id = "resp"></p>
    		<input id="fire" type="button" value="選択" onclick="touchAPI1()"/>
			<p><a id="modal-close" class="button-link">閉じる</a></p>
		</div>
		<a-scene
            renderer="logarithmicDepthBuffer: true;"
            embedded
            loading-screen="enabled: false;"
            arjs="sourceType: webcam; debugUIEnabled: true;"
        >
            <a-camera gps-camera="gpsMinDistance:5;" rotation-reader></a-camera>
        </a-scene>
		<!-- ここまでモーダルウィンドウ -->


		<HR style="margin: 3em 0 ;">
		
		<p style="text-align:center"><a href="https://syncer.jp/jquery-modal-window">配布元: Syncer</a></p>
		
		
		<script type="text/javascript">
			var myElement = document.getElementById('fire');

			export class CalcVR {
			  constructor() {
			    this.latBetween = 0;
			    this.lonBetween = 0;
			  }
		  
			  connectPoints(lastPosition,target) {
			    this.splitsLat = [];
			    this.splitsLon = [];
			    this.latBetween = (lastPosition[0]-target[0])/15;
			    this.lonBetween = (lastPosition[1]-target[1])/15;
			    for (let t = 0; t < 15; t++) {
			      this.splitsLat.push(lastPosition[0] - this.latBetween*t);
			      this.splitsLon.push(lastPosition[1] - this.lonBetween*t);
			    }
			  }
			}

			function staticLoadPlaces() {
			  return coordinates;
			}


			myElement.addEventListener('click', function(event) {
				navigator.geolocation.getCurrentPosition(success, error, options);
				console.log('My HTML element was clicked, woot woot!');
			});

			// function touchAPI1(){
			//   navigator.geolocation.getCurrentPosition(success, error, options);
			// }

			function callAPIOCI(places, url, pos){
			  let coordinates = [];
			  let lat;
			  let lon;
			  var crd = pos.coords;
			  let currentlat = crd.latitude;
			  let currentlon = crd.longitude;
			  let scene = document.querySelector("a-scene");
			  let cal = new CalcVR();
			  let id = 0;
			  let lastlat = crd.latitude;
			  let lastlon = crd.longitude;
			
			  const locationAPI = async(urlz) =>{
			    const response = await fetch(urlz,{method : "get"});
			    const json = response.json();
			    if (response.status == 200){
			      return Promise.resolve(json);
			    }else{
			      return Promise.reject(json.error);
			    }
			  }
		  
			  locationAPI(url)
			    .then(function(data){
			      return new Promise(function (resolve,reject){
			      const jsonObj = JSON.stringify(data);
			      const items = data.items;
			      lat = items[0]["lat"];
			      lon = items[0]["lon"];
			      const location = lon +", " + lat;
			      console.log(lat);
			      console.log(jsonObj);
			      document.getElementById("resp").textContent = location ;
			      resolve(location);});
			    })
			    .then(function(value){
			      let request = new XMLHttpRequest();
			      request.open('POST', "https://api.openrouteservice.org/v2/directions/foot-walking/geojson");
			      request.setRequestHeader('Accept', 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8');
			      request.setRequestHeader('Content-Type', 'application/json');
			      request.setRequestHeader('Authorization', '5b3ce3597851110001cf6248a9c8937ac7a74664b0dc317c69d6c058');
			      request.onreadystatechange = function () {
			        if (this.readyState === 4) {
			          console.log('Status:', this.status);
			          console.log('Headers:', this.getAllResponseHeaders());
			          console.log('Body:', this.responseText);
			        }
			      };
			      console.log(value);
			      const body = '{"coordinates":[['+ currentlon +', '+ currentlat +'],['+ value + ']]}';
			      request.send(body);
			      const geoJSON = request.responseText;
			      console.log(geoJSON);
			    })
			    .catch((err) =>{
			      console.log(err);
			    });
			
			
			  const json = geoJSON.json(); //awaitして、resにjson()を適用させたものをjsonの中に
			  const coords = json.features[0].geometry.coordinates; //jsonのroutesのgeometryのcoordinatesをcoordsに
			  coordinates = coords.map((coord) => { //coordsの配列の一つ一つに対してcoordというアロー関数を使ってcoordinatesに
			    return {
			      name: "test",
			      location: {
			        lat: coord[1],
			        lon: coord[0],
			      },
			    };
			  });
			  console.log(coordinates);
		  
		  
			  places.forEach((place) => {
			    let latitude = place.location.lat;
			    let longitude = place.location.lon;
			    let name = id++;
			    console.log(latitude);
			
			    console.log(`heading: ${crd.heading}`);
			    cal.connectPoints([lastlat,lastlon], [latitude, longitude]);
			
			    let model = document.createElement("a-text");
			    model.setAttribute("value", `${name}`);
			    model.setAttribute("look-at", "[gps-camera]");
			    model.setAttribute(
			      "gps-entity-place",
			      `latitude: ${latitude}; longitude: ${longitude};`
			    );
			    model.setAttribute("scale", `${1} ${1} ${1}`);
			    model.addEventListener("loaded", () => {
			      window.dispatchEvent(new CustomEvent("gps-entity-place-loaded"));
			    });
			    scene.appendChild(model);
			
			    for (let i = 0; i < 15; i++) {
			      let model2 = document.createElement("a-box");
			      model2.setAttribute("material", `color:red`);
			      model2.setAttribute(
			        "gps-entity-place",
			        `latitude: ${cal.splitsLat[i]}; longitude: ${cal.splitsLon[i]};`
			      );
			      model2.setAttribute("scale", `${1} ${1} ${1}`);
			      model2.addEventListener("loaded", () => {
			        window.dispatchEvent(new CustomEvent("gps-entity-place-loaded"));
			      });
			      scene.appendChild(model2);
			    }
			      lastlat = latitude;
			      lastlon = longitude;
			  });
			}

			var options = {
			  enableHighAccuracy: true,
			  timeout: 50000,
			  maximumAge: 0,
			};

			function success(pos) {
			  const urlTemp = "https://g965edebf922493-cojt1.adb.ap-osaka-1.oraclecloudapps.com/ords/admin/tslo/2/";
			  const place = document.getElementById("plase").value;
			  const URL = urlTemp + place;
			
			  let places = staticLoadPlaces();
			  const JN = callAPIOCI(places, URL, pos);
			
			  console.log(JN);
			}

			function error(err) {
			  console.warn(`ERROR(${err.code}): ${err.message}`);
			  alert("Unable to capture current location.");
			}

			console.log("JavaScriptを実行しています");
		</script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="modal.js"></script>
		
	</body>
</html>
